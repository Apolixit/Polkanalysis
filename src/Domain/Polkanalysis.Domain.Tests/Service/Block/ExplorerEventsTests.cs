using Microsoft.Extensions.Logging;
using NSubstitute;
using Polkanalysis.Domain.Contracts.Service;
using Polkanalysis.Domain.Runtime;
using Polkanalysis.Domain.Service;
using Polkanalysis.Domain.Tests.Abstract;
using Polkanalysis.Infrastructure.Blockchain.Contracts;
using Polkanalysis.Infrastructure.Blockchain.Contracts.Core.ExtrinsicTmp;
using Polkanalysis.Infrastructure.Blockchain.Contracts.Pallet.System.Enums;
using Polkanalysis.Infrastructure.Blockchain.Contracts.Runtime;
using Polkanalysis.Infrastructure.Blockchain.Contracts.Runtime.Mapping;
using Polkanalysis.Infrastructure.Blockchain.Contracts.Runtime.Module;
using Polkanalysis.Infrastructure.Blockchain.Runtime;
using Substrate.NET.Metadata.Service;
using Substrate.NetApi.Model.Types.Base;
using Substrate.NetApi.Model.Types.Primitive;

namespace Polkanalysis.Domain.Tests.Service.Block
{
    public class ExplorerEventsTests : DomainTestAbstract
    {
        protected IExplorerService _explorerService;
        protected ISubstrateService _substrateService;
        protected ISubstrateDecoding _substrateDecoding;
        public ExplorerEventsTests() {
            _substrateService = Substitute.For<ISubstrateService>();
            _substrateDecoding = new SubstrateDecoding(Substitute.For<INodeMapping>(),
                                                       _substrateService,
                                                       Substitute.For<IPalletBuilder>(),
                                                       Substitute.For<ILogger<SubstrateDecoding>>());

            _explorerService = new ExplorerService(_substrateService,
                                                   _substrateDecoding,
                                                   Substitute.For<IAccountService>(),
                                                   Substitute.For<ILogger<ExplorerService>>(), 
                                                   Substitute.For<ICoreService>());
        }

        /// <summary>
        /// Polkadot, block number = 14000000 (hash : 0xca4fd82b8c8aa20def36a4d895b2ceb245532e3be4324a8fddef676596cabc8e)
        /// Events.TakeAndEncode(3)
        /// </summary>
        /// <param name="eventHex"></param>
        /// <returns></returns>
        [Test]
        //[TestCase("0x080210082DF3BC5411EFA7040000000000000000C2CA026411EFA70400000000000000000000000000000000620B433D5517020000")]
        [TestCase("0x0C0000000000015901506F6C6B616E616C797369732E506F6C6B61646F742E4E65744170694578742C2056657273696F6E3D312E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D6E756C6C5D01506F6C6B616E616C797369732E506F6C6B61646F742E4E65744170694578742E47656E6572617465642E4D6F64656C2E76393334302E706F6C6B61646F745F72756E74696D652E456E756D52756E74696D654576656E740000C2B131340002000000C2B13134000200000001000000015901506F6C6B616E616C797369732E506F6C6B61646F742E4E65744170694578742C2056657273696F6E3D312E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D6E756C6C5D01506F6C6B616E616C797369732E506F6C6B61646F742E4E65744170694578742E47656E6572617465642E4D6F64656C2E76393334302E706F6C6B61646F745F72756E74696D652E456E756D52756E74696D654576656E743501E9030000CBF2FBE562E1C4A428445B31E7BB3F83580B8EEA7AF8B91E1AE7C3D479A8461CAE989386DC583E7ACD97D06B5CDCA0D7D67CB17A989AD2B5A7A3C4BB948F943EB46869DCBA2386957823C70A9566E2C08C7246C34EF1818C2C6BC3C1E58EA6EDABF7063ED70F439B8D678F595850A639B49538B1D2D06FF52E54C5E0FAEAD7E6EAE7D6AD08FB93C3EF9C2839DC04F9BA0C4AC3985215C837C77DA40A2F62C41B2CCE4801C5AD3C818D4CA79725EAD727E4F7167F63D9128BBD97643292D8F47AABF393C2A980AA77228C068D1C3B9C765E2F8EDF329C5D81935FFCCC9D3A5986D5E29EEDB60B0866127C4A7D6FFFE95B525D1A562132CBFF667DBF7AA34B9839DE7616501046DA7138C35E0B4699BF403A09523533F30E0E5180DBB5FB8FEC4DE0ED39FA1ECAF2A021787DAB4F3CE8175DB5ABB4CB3E755908160861A4660D53E902C570FABB6DB2650B05E267BD0B1C5C89472A4D6FA2D8CB65A3726B8CA840C74926A71D00E642120C87A88863BEDBE8DDA0C7462F3CEDC3EAFA5BF070FF74E55F24321C775671849A67ED8F67D49D463795CDA173E525A36DE3F353450E0212723EDFAA9E080661757261209BC251080000000005617572610101F80F0F2BFDA205D07F70B4C1F14215E47F7BF9E29BE890AE070AAB885E726A069C37B41E4A063B8AA600E46E8A05E986A9DAAB2E2C56F0CA8FCCA1C78A06D08C01000000110000001E01E9030000CBF2FBE562E1C4A428445B31E7BB3F83580B8EEA7AF8B91E1AE7C3D479A8461CAE989386DC583E7ACD97D06B5CDCA0D7D67CB17A989AD2B5A7A3C4BB948F943EB46869DCBA2386957823C70A9566E2C08C7246C34EF1818C2C6BC3C1E58EA6EDABF7063ED70F439B8D678F595850A639B49538B1D2D06FF52E54C5E0FAEAD7E6EAE7D6AD08FB93C3EF9C2839DC04F9BA0C4AC3985215C837C77DA40A2F62C41B2CCE4801C5AD3C818D4CA79725EAD727E4F7167F63D9128BBD97643292D8F47AABF393C2A980AA77228C068D1C3B9C765E2F8EDF329C5D81935FFCCC9D3A5986D5E29EEDB60B0866127C4A7D6FFFE95B525D1A562132CBFF667DBF7AA34B9839DE7616501046DA7138C35E0B4699BF403A09523533F30E0E5180DBB5FB8FEC4DE0ED39FA1ECAF2A021787DAB4F3CE8175DB5ABB4CB3E755908160861A4660D53E902C570FABB6DB2650B05E267BD0B1C5C89472A4D6FA2D8CB65A3726B8CA840C74926A71D00E642120C87A88863BEDBE8DDA0C7462F3CEDC3EAFA5BF070FF74E55F24321C775671849A67ED8F67D49D463795CDA173E525A36DE3F353450E0212723EDFAA9E080661757261209BC251080000000005617572610101F80F0F2BFDA205D07F70B4C1F14215E47F7BF9E29BE890AE070AAB885E726A069C37B41E4A063B8AA600E46E8A05E986A9DAAB2E2C56F0CA8FCCA1C78A06D08C0100000011000000000001000000015901506F6C6B616E616C797369732E506F6C6B61646F742E4E65744170694578742C2056657273696F6E3D312E302E302E302C2043756C747572653D6E65757472616C2C205075626C69634B6579546F6B656E3D6E756C6C5D01506F6C6B616E616C797369732E506F6C6B61646F742E4E65744170694578742E47656E6572617465642E4D6F64656C2E76393334302E706F6C6B61646F745F72756E74696D652E456E756D52756E74696D654576656E743501D0070000CBF2FBE562E1C4A428445B31E7BB3F83580B8EEA7AF8B91E1AE7C3D479A8461C1EF6DF7BD4EC445A852294CAAFA0D91BA8E3089E0B79CEFB4D1786EE640A43515143649495C844663F7C48B9A397991A012B4BC14B1EDC574BDFC1AF8F06BE8DA8FED3C6B8A280DAA8517416D13AA1B7D10020CC5CDBDB403D83603A7EB3E8F1D6FC040B006ACDC24AAE164E26C04FCDE3C9BFB19ADB7907D723B4172CED2141CE6DD37525D2565DB205C3472A68482C40B5F70519E5B90F75C48A70671F3E474511A71B23270AFBB5B1110FA08D50C4B4F26CC7428BD59837F6F6B90E10AE85009DDE9C355D5905EED957BA953E9E8E57006AEFC81C4BBE1689CAB466C7E4E3F62C1C225B50B798CEE69ABE7FFCD04151B0972D3CCF61EC71E4E30ECAE9E506F1E98C10AE4C876622F65A76BEB2B0E397BDF1E0E2081817DE816A7F14CAE4ECE9026E8B9D7448746FE4D883A1D0813BC8198BDF460636C872B82553512E7CCD065FF260AC008F1D13289EB7256031AAFDCFDCBFF022731681F916DED1CB120B0E19617E05BDB041B0E535351CEEC9E8CD5FD54CB0F8F1F53F7CBFCBFA7680357846BB200612080661757261209BC251080000000005617572610101EC184AA18E91C863E4E1720FB5461522438187144F0EB8830A7E6D47FCD5C75A7B028785CE2CF7033476A963AC866BD1B90856DF55D1FED6E3A3A4F1C22ACC8202000000120000001E01D0070000CBF2FBE562E1C4A428445B31E7BB3F83580B8EEA7AF8B91E1AE7C3D479A8461C1EF6DF7BD4EC445A852294CAAFA0D91BA8E3089E0B79CEFB4D1786EE640A43515143649495C844663F7C48B9A397991A012B4BC14B1EDC574BDFC1AF8F06BE8DA8FED3C6B8A280DAA8517416D13AA1B7D10020CC5CDBDB403D83603A7EB3E8F1D6FC040B006ACDC24AAE164E26C04FCDE3C9BFB19ADB7907D723B4172CED2141CE6DD37525D2565DB205C3472A68482C40B5F70519E5B90F75C48A70671F3E474511A71B23270AFBB5B1110FA08D50C4B4F26CC7428BD59837F6F6B90E10AE85009DDE9C355D5905EED957BA953E9E8E57006AEFC81C4BBE1689CAB466C7E4E3F62C1C225B50B798CEE69ABE7FFCD04151B0972D3CCF61EC71E4E30ECAE9E506F1E98C10AE4C876622F65A76BEB2B0E397BDF1E0E2081817DE816A7F14CAE4ECE9026E8B9D7448746FE4D883A1D0813BC8198BDF460636C872B82553512E7CCD065FF260AC008F1D13289EB7256031AAFDCFDCBFF022731681F916DED1CB120B0E19617E05BDB041B0E535351CEEC9E8CD5FD54CB0F8F1F53F7CBFCBFA7680357846BB200612080661757261209BC251080000000005617572610101EC184AA18E91C863E4E1720FB5461522438187144F0EB8830A7E6D47FCD5C75A7B028785CE2CF7033476A963AC866BD1B90856DF55D1FED6E3A3A4F1C22ACC82020000001200000000")]
        public async Task ValidEvent_ShouldReturnDtoAsync(string eventHex)
        {
            var blockHash = "0xca4fd82b8c8aa20def36a4d895b2ceb245532e3be4324a8fddef676596cabc8e";

            var eventMock = new BaseVec<EventRecord>();
            eventMock.Create(eventHex);
            _substrateService.At(Arg.Any<Hash>()).Storage.System.EventsAsync(CancellationToken.None).Returns(eventMock);

            _substrateService.At(Arg.Any<Hash>()).GetMetadataAsync(CancellationToken.None).Returns(Substrate.NET.Utils.Core.MetadataHelper.GetMetadataFromHex(MockMetadata1));

            _substrateService.Rpc.Chain.GetBlockAsync(Arg.Any<Hash>(), CancellationToken.None).Returns(
                new TempOldBlockData(
                    new TempOldBlock() { 
                        Header = new Substrate.NetApi.Model.Rpc.Header() { 
                            Number = new U64(1_000_000) 
                        } 
                    }, null)
                );

            var dto = await _explorerService.GetEventsAsync(blockHash, CancellationToken.None);

            Assert.That(dto.Count, Is.EqualTo(3));
        }
    }
}
